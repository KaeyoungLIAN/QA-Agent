# 客服问答系统（RAG + Agent + LangChain）

## 一、项目概述

本项目旨在构建一个智能客服问答系统，支持：

- 基于 **员工手册/FAQ** 的智能问答（RAG 检索增强生成）。
- 自动识别与调用 **订单数据库查询工具**，实现个性化订单状态查询与反馈。
- 提供 REST API 接口与演示前端，可扩展为企业级客服机器人。

---

## 二、功能列表

### 1. MVP 功能

- **知识库问答（RAG）**
  - 支持基于员工手册、FAQ 的检索增强生成问答
  - 返回引用文档，保证答案可追溯
- **订单查询（Agent 工具调用）**
  - 按订单号精确查询状态、物流、金额、下单时间等信息
  - 按邮箱/手机号模糊查询最近订单
- **检索增强**
  - 混合检索（向量 + 关键词 BM25）
  - 可选 Reranker 提升相关性
- **API 接口**
  - `/chat` 聊天接口（问答+工具调用结果）
  - `/ingest` 文档导入接口（开发用）
- **基础安全机制**
  - 当知识不足或数据缺失时，不编造，提示用户联系人工
  - 工具查询无结果时，引导用户提供更多信息

### 2. 可选增强功能（如进度允许）

- Reranker（bge-reranker）重排检索结果
- 多轮对话记忆（3–5 轮）
- RAGAS 或自定义评测脚本
- 权限与访问控制（API Token）
- Docker 容器化部署

---

## 三、技术栈选择

| 模块               | 技术/工具              | 说明                     |
| ------------------ | ---------------------- | ------------------------ |
| **语言 & 框架**    | Python 3.11 + FastAPI  | API 开发、快速部署       |
| **RAG 编排**       | LangChain              | 检索、链式调用、工具封装 |
| **Agent**          | LangChain Tools        | 工具调用与多步任务编排   |
| **模型**           | Ollama + Llama3.1 8B   | 根据需求选择云端或本地   |
| **Embedding**      | bge-m3                 | 支持中英多语嵌入         |
| **向量数据库**     | FAISS                  | 本地高效向量检索         |
| **关键词检索**     | BM25（rank_bm25）      | 与向量检索混合提升召回率 |
| **数据库（订单）** | SQLite                 | 存储订单信息             |
| **评测工具**       | RAGAS / 自定义脚本     | 检查准确率、引用覆盖率   |
| **容器化**         | Docker                 | 可选部署方式             |
| **日志与监控**     | LangSmith / 结构化日志 | 调试与分析               |

## 四、项目进度计划（3–4 天）

| 日期/阶段              | 任务目标              | 主要工作内容                                                                                                                                                                                                                       | 产出物                                                                                           |
| ---------------------- | --------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------ |
| **Day 1**              | 项目骨架 & 数据准备   | - 初始化 FastAPI 项目结构与 `/chat` 路由<br>- 设计并创建订单数据库（SQLite）及 mock 数据<br>- 整理员工手册/FAQ，转为 Markdown 并按段落切分<br>- 建立向量索引（bge-m3 + FAISS）及 BM25 索引<br>- 打通最小 RAG 流程，能回答 FAQ 问题 | - 基础项目目录与代码骨架<br>- SQLite 数据库文件<br>- 向量索引与检索代码<br>- MVP 版 RAG 问答接口 |
| **Day 2**              | Agent 工具 & 意图路由 | - 封装订单查询工具（按订单号、邮箱/手机号查询）<br>- 编写意图分类逻辑（关键词+LLM）<br>- 将订单查询结果与 LLM 汇总成自然语言答案<br>- 实现工具调用异常与无结果处理逻辑                                                             | - Agent 工具代码（SQLDatabaseToolkit 封装）<br>- 意图分类模块<br>- 工具调用示例与返回格式        |
| **Day 3**              | 检索优化 & 质量提升   | - 启用混合检索（BM25 + 向量检索）<br>- （可选）集成 Reranker 提升相关性<br>- 优化提示词，确保引用准确、减少幻觉<br>- 准备评测集（FAQ + 订单类）并测试准确率<br>- 添加接口延时与命中日志                                            | - 优化后的检索模块<br>- 改进提示词模板<br>- 评测集与测试结果                                     |
| **Day 4**（可选/打磨） | 演示与部署            | - 添加多轮对话简易记忆（3–5 轮）<br>- 编写 Dockerfile 与部署脚本<br>- 优化 README，添加架构图与运行指南<br>- 准备 Demo 演示视频                                                                                                    | - 支持多轮的 `/chat` 接口<br>- Docker 镜像与部署文档<br>- 演示视频与使用说明                     |

## 五、数据库设计

> 目标：为客服 RAG + Agent 提供最小可用、查询友好的订单数据结构。  
> 特点：字段精简、易于 SQL 检索、与话术模板变量一一对应、支持后续平滑扩展。

### 1. 表结构概览

- 表名：`orders`
- 主键：`order_id`
- 用途：支持精确查询（订单号）与模糊查询（邮箱/手机号/下单时间范围），为客服话术提供动态变量。

### 2 字段说明

| 字段名         | 类型                 | 约束   | 说明                                                     | 示例值                 |
| -------------- | -------------------- | ------ | -------------------------------------------------------- | ---------------------- |
| `order_id`     | TEXT / VARCHAR(32)   | **PK** | 订单唯一编号                                             | `OD2408150001`         |
| `user_id`      | TEXT / VARCHAR(32)   |        | 用户内部 ID                                              | `U123456`              |
| `user_name`    | TEXT / VARCHAR(100)  |        | 收货人姓名（存全量；对外展示需脱敏）                     | `张三`                 |
| `email`        | TEXT / VARCHAR(255)  | INDEX  | 用户邮箱（支持按邮箱查询订单）                           | `zhang@example.com`    |
| `phone`        | TEXT / VARCHAR(20)   | INDEX  | 用户手机号（存全量；对外展示需脱敏）                     | `13800000000`          |
| `status`       | TEXT / VARCHAR(50)   |        | 订单状态（如：待支付 / 已支付待发货 / 已发货 / 已签收…） | `已发货`               |
| `tracking_no`  | TEXT / VARCHAR(50)   |        | 运单号（可用于外部物流查询；不区分快递公司）             | `SF123456789CN`        |
| `item_summary` | TEXT                 |        | 商品摘要（便于客服快速确认）                             | `蓝牙耳机x1, 保护壳x1` |
| `total_amount` | DECIMAL(10,2)        |        | 总金额                                                   | `499.00`               |
| `created_at`   | DATETIME / TIMESTAMP | INDEX  | 下单时间（支持时间范围检索）                             | `2025-08-10 09:21:00`  |
| `address`      | TEXT                 |        | 收货地址（存全量；对外展示需脱敏）                       | `北京市朝阳区望京…`    |

> 说明：以上类型在 SQLite / PostgreSQL / MySQL 中略有差异，下面提供三种主流方言的建表示例。
