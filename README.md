# 🛠️ Kaeyounglian QA Agent

一个基于 **LangChain + RAG + SQLite + Ollama** 的智能客服问答系统。  
该项目实现了 **订单数据库查询、流程规则检索、FAQ 话术生成** 的一体化客服 Agent，支持 **ReAct 工具调用** 与 **检索增强生成 (RAG)**。

---

## ✨ 功能特性

1. **智能客服对话**

   - 基于 `ReAct` 推理模式，自动选择合适工具回答问题。
   - 支持 **政策/流程/话术** 查询、**订单状态查询/修改** 等。

2. **数据库查询工具**

   - 按订单号、手机号、邮箱检索订单。
   - 修改订单收货地址（含权限与状态判断）。
   - 输出统一结构化结果，便于合成自然语言答复。

3. **RAG 检索增强问答**

   - 将业务文档（流程 flows.md + 话术 utterances.md）切分并存入 **FAISS 向量库**。
   - 支持 **文档问答工具 doc_qa**，可结合数据库返回的事实生成合规答复。

4. **流程 & 话术分离**

   - `flows.md`：流程逻辑（应该怎么做）。
   - `utterances.md`：话术模版（应该怎么说）。
   - 二者 **目录与 ID 完全对齐**，便于多模态拼接。

5. **脱敏与合规模块**
   - 邮箱、手机号、地址对外展示自动脱敏。
   - 强制校验 `user_id`，禁止跨账号查询。
   - 修改操作记录审计日志，保障合规性。

---

## ⚙️ 技术栈选择

- **语言**：Python 3.10+
- **LLM**：Ollama (`llama3.1`)
- **框架**：LangChain (ReAct Agent + ConversationalRetrievalChain)
- **检索**：FAISS 向量数据库 + BAAI bge-m3 Embedding
- **数据库**：SQLite (轻量级、易于测试与演示)
- **存储格式**：Markdown + JSONL（流程与话术文档分块）

---

## 📂 数据库设计

> 目标：为客服 RAG + Agent 提供最小可用、查询友好的订单数据结构。  
> 特点：字段精简、易于 SQL 检索、与话术模板变量一一对应、支持后续平滑扩展。

### 1. 表结构概览

- 表名：`orders`
- 主键：`order_id`
- 用途：支持精确查询（订单号）与模糊查询（邮箱/手机号/下单时间范围），为客服话术提供动态变量。

### 2. 字段说明

| 字段名         | 类型                 | 约束   | 说明                                                     | 示例值                 |
| -------------- | -------------------- | ------ | -------------------------------------------------------- | ---------------------- |
| `order_id`     | TEXT / VARCHAR(32)   | **PK** | 订单唯一编号                                             | `OD2408150001`         |
| `user_id`      | TEXT / VARCHAR(32)   |        | 用户内部 ID                                              | `U123456`              |
| `user_name`    | TEXT / VARCHAR(100)  |        | 收货人姓名（存全量；对外展示需脱敏）                     | `张三`                 |
| `email`        | TEXT / VARCHAR(255)  | INDEX  | 用户邮箱（支持按邮箱查询订单）                           | `zhang@example.com`    |
| `phone`        | TEXT / VARCHAR(20)   | INDEX  | 用户手机号（存全量；对外展示需脱敏）                     | `13800000000`          |
| `status`       | TEXT / VARCHAR(50)   |        | 订单状态（如：待支付 / 已支付待发货 / 已发货 / 已签收…） | `已发货`               |
| `tracking_no`  | TEXT / VARCHAR(50)   |        | 运单号（可用于外部物流查询；不区分快递公司）             | `SF123456789CN`        |
| `item_summary` | TEXT                 |        | 商品摘要（便于客服快速确认）                             | `蓝牙耳机x1, 保护壳x1` |
| `total_amount` | DECIMAL(10,2)        |        | 总金额                                                   | `499.00`               |
| `created_at`   | DATETIME / TIMESTAMP | INDEX  | 下单时间（支持时间范围检索）                             | `2025-08-10 09:21:00`  |
| `address`      | TEXT                 |        | 收货地址（存全量；对外展示需脱敏）                       | `北京市朝阳区望京…`    |

> 说明：以上类型在 SQLite / PostgreSQL / MySQL 中略有差异，项目默认使用 SQLite，便于快速开发与测试。

---
