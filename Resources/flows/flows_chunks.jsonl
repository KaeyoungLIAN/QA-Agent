{"id": "af714aac-0d64-44a8-9677-7131519995e3", "text": "# flows.md  \n版本：v1.0\n最后更新：2025-08-14  \n> 本文档用于**流程逻辑（应该怎么做）**，与 `utterances.md` 通过完全一致的 `category / subcategory / id` 做一一映射，方便在 RAG 中进行“流程 + 话术”的组合生成。  \n---", "metadata": {"h1": "flows.md", "section_path": "flows.md", "source": "flows_wo_toc.md"}}
{"id": "e955b17e-51ae-43ce-92f3-f87899687bbf", "text": "## 顶层配置（可按需修改并在系统初始化时注入）  \n```yaml\nvars:\nno_reason_days: 7 # 无理由退货期（自然日）\nquality_days: 15 # 质量问题退换期限（自然日/或按内部政策设定）\nrefund_sla_days: 3 # 仓检通过后退款原路退回的承诺时效（工作日）\ninvoice_apply_days: 90 # 允许申请发票的最长期限（自然日）\ninvoice_issue_days: 2 # 发票审核通过后开具的承诺时效（工作日）\n\nwarehouse_process_hours: 24 # 付款到出库的承诺时长（小时）\ncity_days_min: 1\ncity_days_max: 2\nprovince_days_min: 2\nprovince_days_max: 3\ncross_days_min: 3\ncross_days_max: 5\nremote_days_min: 4\nremote_days_max: 7\n\nrestock_days: 5 # 缺货补货参考时长（自然日）\npolicy_link: https://example.com/policy/returns\n```  \n---", "metadata": {"h1": "flows.md", "h2": "顶层配置（可按需修改并在系统初始化时注入）", "section_path": "flows.md > 顶层配置（可按需修改并在系统初始化时注入）", "source": "flows_wo_toc.md"}}
{"id": "a6783704-2889-4c3f-98d0-780527702bad", "text": "## 数据模型与安全  \n- 订单表（只列关键字段）：  \n- `order_id (PK)`：订单唯一编号（如：`OD2408150001`）\n- `user_id`：用户内部 ID（仅用于权限校验，不向外展示）\n- `user_name (TEXT)`：收货人姓名（对外展示需脱敏或遵循合规）\n- `email (INDEX)`：邮箱（支持邮箱+时间范围检索；对外展示需脱敏）\n- `phone (INDEX)`：手机号（支持手机+时间范围检索；对外展示需脱敏）\n- `status`：状态（如：待支付 / 已支付待发货 / 已发货 / 已签收 / 退款中 / 已退款…）\n- `tracking_no`：运单号（跨系统查询物流）\n- `item_summary`：简要的商品摘要（便于客服和用户快速确认）\n- `total_amount (DECIMAL)`：订单总额\n- `created_at (DATETIME/TIMESTAMP)`：下单时间\n- `address (TEXT)`：收货地址（对外展示需脱敏）  \n- **隐私与合规模块（必须遵循）**：  \n- 对外展示的个人信息一律脱敏：\n- `email` → `z***@example.com`\n- `phone` → `138****0000`\n- `address` → “北京市朝阳区**路**号…”（街道号后脱敏）\n- **严禁跨用户查询**：任意订单读取前必须核验 `user_id == current_user_id` 或完成 OTP 账号验证。\n- **审计与幂等**：修改动作写入审计日志（时间、操作者、变更前后哈希）；对重复指令使用幂等键（如 `order_id + action`）。  \n- **可调用工具（Agent）**（伪接口说明）：\n- `OrderDB.get(order_id) -> Order`\n- `OrderDB.find_by_contact(contact, start, end) -> [Order]`\n- `OrderDB.update_address(order_id, new_address) -> bool`\n- `LogisticsAPI.get(tracking_no) -> {carrier, events[], eta}`\n- `LogisticsAPI.intercept(tracking_no, new_address) -> {accepted: bool}`\n- `OMS.create_return_request(order_id, reason, attachments) -> {RMA, refund_amount}`\n- `Payment.refund(order_id, amount) -> {accepted: bool}`", "metadata": {"h1": "flows.md", "h2": "数据模型与安全", "section_path": "flows.md > 数据模型与安全", "source": "flows_wo_toc.md"}}
{"id": "0d2ef800-a397-48a2-8ea4-790c04f6cd37", "text": "- `Payment.refund(order_id, amount) -> {accepted: bool}`\n- `Ticket.create(severity, summary, attachments) -> {ticket_id}`\n- `Invoice.request(order_id, type, title, tax_id, email) -> {invoice_id}`\n- `Inventory.promise_or_cancel(order_id, option) -> {ok: bool}`  \n---", "metadata": {"h1": "flows.md", "h2": "数据模型与安全", "section_path": "flows.md > 数据模型与安全", "source": "flows_wo_toc.md"}}
{"id": "d309315b-98b1-489f-ac96-9e6420230fe3", "text": "## 1. 订单相关（orders）  \n### 1.1 查询订单状态（id: `orders.status_query`）  \n**触发意图**  \n- 关键词：查订单 / 物流 / 到哪了 / 单号 / 状态 / 快递 / ETA 等  \n**输入优先级**  \n1. `order_id`（首选） → 2) 账号验证 + `email/phone` → 3) 通过 `created_at` 时间范围回溯定位最近订单（回退方案）。  \n**流程步骤**  \n1. **识别与收集**：尝试获取 `order_id`。若缺失，引导用户提供 `email/phone` 与时间范围。\n2. **权限校验**：从 `OrderDB.get(order_id)` 读取，校验 `order.user_id == current_user_id`，否则拒绝并提供 OTP 验证流程。\n3. **信息返回**：返回字段 `status、tracking_no、item_summary、total_amount、created_at、address(脱敏)`。\n4. **物流查询**：若存在 `tracking_no`，调用 `LogisticsAPI.get(tracking_no)` 获取 `carrier/轨迹/eta`。\n5. **状态解释与建议下一步**：\n- 待支付：给出支付指引（链接/入口）。\n- 已支付待发货：提示 `{warehouse_process_hours}` 小时内出库，若需改地址引导到“地址修改”。\n- 已发货：展示物流轨迹与 `eta`，提供拦截/自提/改约送达的可能性（取决于承运商）。\n- 已签收：提示可在 `{vars.no_reason_days}` 内按政策发起退货。\n- 退款中/已退款：展示退款节点与原路退回时效 `{refund_sla_days}`。\n6. **异常分支**：\n- 查无结果 / 多单匹配：要求补充 `order_id` 或更精确的时间范围。\n- 物流接口超时：返回订单核心状态并声明“物流刷新中”。\n7. **审计与指标**：记录查询耗时、接口成功率、用户满意度标签。  \n**伪代码**  \n```python\norder = OrderDB.get(order_id) or locate_by_contact(contact, start, end)\nassert_user_access(order, current_user_id)  # raise if fail", "metadata": {"h1": "flows.md", "h2": "1. 订单相关（orders）", "h3": "1.1 查询订单状态（id: `orders.status_query`）", "section_path": "flows.md > 1. 订单相关（orders） > 1.1 查询订单状态（id: `orders.status_query`）", "source": "flows_wo_toc.md"}}
{"id": "535597bc-6ff7-4f03-a598-47ca9a24da59", "text": "resp = {\n\"status\": order.status,\n\"item_summary\": order.item_summary,\n\"total_amount\": order.total_amount,\n\"created_at\": order.created_at,\n\"address_masked\": mask(order.address)\n}\n\nif order.tracking_no:\ntrack = LogisticsAPI.get(order.tracking_no)\nresp.update({\"tracking_no\": order.tracking_no, \"carrier\": track.carrier, \"eta\": track.eta})\nreturn resp\n```  \n---", "metadata": {"h1": "flows.md", "h2": "1. 订单相关（orders）", "h3": "1.1 查询订单状态（id: `orders.status_query`）", "section_path": "flows.md > 1. 订单相关（orders） > 1.1 查询订单状态（id: `orders.status_query`）", "source": "flows_wo_toc.md"}}
{"id": "66fc9e37-00d2-4512-a605-964b7aeb36d4", "text": "### 1.2 修改收货地址（id: `orders.address_update`）  \n**前置**  \n- 允许：`status ∈ {已支付待发货, 待发货}` → 直接改地址。\n- 已发货：尝试承运商拦截改派（不保证成功）。\n- 已签收：不支持改地址。  \n**输入**  \n- 新地址结构：`{收件人, 手机, 省市区, 详细地址, 邮编}`。必要时二次验证手机号。  \n**流程步骤**  \n1. **订单确认 + 权限校验**：同 1.1。\n2. **可改性判断**：根据状态决定“直接修改 / 尝试拦截 / 不支持”。\n3. **风控校验**：高风险地址策略（频繁变更、黑名单小区、异常邮编等）→ 人工复核队列。\n4. **执行与回执**：\n- 未发货：`OrderDB.update_address(order_id, new_address)`，记录审计日志（旧地址哈希/新地址哈希）。\n- 已发货：`LogisticsAPI.intercept(tracking_no, new_address)`，返回是否受理与预计影响的 `eta` 变化。\n5. **通知与确认**：向原留 `email/phone` 发送变更确认，防止冒用。  \n**失败处理**  \n- 拦截失败：提供改约/自提/签收后退货的替代方案。  \n---", "metadata": {"h1": "flows.md", "h2": "1. 订单相关（orders）", "h3": "1.2 修改收货地址（id: `orders.address_update`）", "section_path": "flows.md > 1. 订单相关（orders） > 1.2 修改收货地址（id: `orders.address_update`）", "source": "flows_wo_toc.md"}}
{"id": "cf56e413-acaf-4da5-b695-b2e3dc6ea11b", "text": "### 1.3 申请退货（id: `orders.return_request`）  \n**联动规则**  \n- 无理由退货：`{no_reason_days}` 天，保持完好不影响二次销售。\n- 质量问题：`{quality_days}` 天内可退/换，需问题证明（照片/视频）。\n- 特殊类目：定制/食品/虚拟等不支持无理由。退款原路退回，`{refund_sla_days}` 个工作日内到账。  \n**流程步骤**  \n1. **状态核验**：仅 `已签收` 或 `在途拒收` 可走退货；`待发货` 建议取消而非退货。\n2. **资格判断**：根据签收时间/下单时间 + 类目判定是否在退货窗口。\n3. **信息收集**：`reason`（枚举）、`attachments`（图片/视频/面单）、退回方式（上门揽收/自寄）。\n4. **创建 RMA**：`OMS.create_return_request(order_id, reason, attachments)` → 得到 `{RMA, refund_amount}` 与退回地址。\n5. **退款规则**：根据责任方判定运费是否退还；明确到账时效 `{refund_sla_days}`。\n6. **跟踪与闭环**：仓检通过 → 触发退款；不通过 → 说明原因并提供申诉通道。\n7. **异常与替代**：超期/不可退品类/风控频繁退货 → 建议换新/补发/部分退款/优惠券补偿。  \n---", "metadata": {"h1": "flows.md", "h2": "1. 订单相关（orders）", "h3": "1.3 申请退货（id: `orders.return_request`）", "section_path": "flows.md > 1. 订单相关（orders） > 1.3 申请退货（id: `orders.return_request`）", "source": "flows_wo_toc.md"}}
{"id": "a6adbe57-7b63-4d7a-a2d7-7db6311bfbb4", "text": "## 2. 规则相关（rules）  \n### 2.1 退换货政策（id: `rules.return_policy`）  \n**输出要点**  \n- 列出：无理由天数 `{no_reason_days}`、质量问题天数 `{quality_days}`、完好标准、不可退类目、运费承担、退款时效 `{refund_sla_days}`、条款链接 `{policy_link}`。\n- 为保证可追溯，回复中应包含“条款链接或版本编号”。  \n**结构化字段（供 Agent 拼装）**  \n```json\n{\n\"no_reason_days\": \"${vars.no_reason_days}\",\n\"quality_days\": \"${vars.quality_days}\",\n\"refund_sla_days\": \"${vars.refund_sla_days}\",\n\"policy_link\": \"${vars.policy_link}\"\n}\n```  \n---", "metadata": {"h1": "flows.md", "h2": "2. 规则相关（rules）", "h3": "2.1 退换货政策（id: `rules.return_policy`）", "section_path": "flows.md > 2. 规则相关（rules） > 2.1 退换货政策（id: `rules.return_policy`）", "source": "flows_wo_toc.md"}}
{"id": "77ea1468-33e0-4f75-8cf7-30ac5de07d81", "text": "### 2.2 物流时效（id: `rules.shipping_sla`）  \n**输出要点**  \n- 仓内处理：`{warehouse_process_hours}` 小时出库（高峰期顺延）。\n- 区域派送（按站点配置区间值）：同城、省内、跨省、偏远。最终以承运商轨迹为准。  \n**结构化字段**  \n```json\n{\n\"warehouse_process_hours\": \"${vars.warehouse_process_hours}\",\n\"city_days_min\": \"${vars.city_days_min}\",\n\"city_days_max\": \"${vars.city_days_max}\",\n\"province_days_min\": \"${vars.province_days_min}\",\n\"province_days_max\": \"${vars.province_days_max}\",\n\"cross_days_min\": \"${vars.cross_days_min}\",\n\"cross_days_max\": \"${vars.cross_days_max}\",\n\"remote_days_min\": \"${vars.remote_days_min}\",\n\"remote_days_max\": \"${vars.remote_days_max}\"\n}\n```  \n---", "metadata": {"h1": "flows.md", "h2": "2. 规则相关（rules）", "h3": "2.2 物流时效（id: `rules.shipping_sla`）", "section_path": "flows.md > 2. 规则相关（rules） > 2.2 物流时效（id: `rules.shipping_sla`）", "source": "flows_wo_toc.md"}}
{"id": "50f9f72f-9e3e-485a-979b-4d82a3274a16", "text": "### 2.3 支付方式（id: `rules.payment_methods`）  \n**输出要点**  \n- 支持的渠道：银行卡（Visa/Master/银联）、第三方钱包（支付宝/微信/PayPal/Apple Pay 等，按站点差异化展示）、分期（部分银行）。\n- 常见失败原因：额度不足、风控拒绝、网络异常、3D 验证失败。\n- 退款路径与时效：原路退回，`{refund_sla_days}` 个工作日内到账（钱包渠道通常更快）。  \n---", "metadata": {"h1": "flows.md", "h2": "2. 规则相关（rules）", "h3": "2.3 支付方式（id: `rules.payment_methods`）", "section_path": "flows.md > 2. 规则相关（rules） > 2.3 支付方式（id: `rules.payment_methods`）", "source": "flows_wo_toc.md"}}
{"id": "fa8bdfb4-954c-4706-bef5-ed9f4185fb28", "text": "## 3. 售后相关（aftersales）  \n### 3.1 投诉处理（id: `aftersales.complaint`）  \n**分级与 SLA（示例）**  \n- 严重：涉及安全/财产/隐私 → 4 小时响应，24 小时内结论或阶段性结果。\n- 一般：服务体验/承诺不符 → 24 小时响应，3 个工作日内处理。  \n**流程步骤**  \n1. 收集：订单号、时间、诉求、证据（截图/录音/快递凭证）。\n2. 立案：`Ticket.create(severity, summary, attachments)` → `ticket_id`。\n3. 调查：调取订单/物流/仓内记录/通话与聊天历史。\n4. 结果：道歉/解释/补发/退款/补偿券/流程优化与培训。\n5. 升级：用户不满意可申请管理层复核；保留书面结论。\n6. 关闭：用户确认或 SLA 内未反馈自动关闭（允许在一定时间内重开）。  \n---", "metadata": {"h1": "flows.md", "h2": "3. 售后相关（aftersales）", "h3": "3.1 投诉处理（id: `aftersales.complaint`）", "section_path": "flows.md > 3. 售后相关（aftersales） > 3.1 投诉处理（id: `aftersales.complaint`）", "source": "flows_wo_toc.md"}}
{"id": "77fafcc8-223c-4f7b-aee8-e81f19c61083", "text": "### 3.2 发票申请（id: `aftersales.invoice`）  \n**规则与步骤**  \n1. 资格：支持开具电子发票（默认）/纸质发票（如政策支持）；申请窗口 `{invoice_apply_days}` 天内。\n2. 信息：抬头（个人/公司）、税号、邮箱、（公司抬头需）地址/电话/开户行及账号。\n3. 执行：`Invoice.request(order_id, type, title, tax_id, email)` → `invoice_id`。\n4. 时效：审核通过后 `{invoice_issue_days}` 个工作日内开具并发送至邮箱；纸票说明邮寄时效与运费规则。\n5. 异常：信息不全/资质不符 → 补正通知；超期不予受理（如有特批渠道需说明）。  \n---", "metadata": {"h1": "flows.md", "h2": "3. 售后相关（aftersales）", "h3": "3.2 发票申请（id: `aftersales.invoice`）", "section_path": "flows.md > 3. 售后相关（aftersales） > 3.2 发票申请（id: `aftersales.invoice`）", "source": "flows_wo_toc.md"}}
{"id": "9f263673-21f5-4bd7-802c-85df375fb258", "text": "### 3.3 缺货处理（id: `aftersales.oos_handling`）  \n**场景**  \n- 下单后仓内缺货或系统超卖。  \n**策略**  \n1. 向用户提供三选一：\n- 等待补货（预计 `{restock_days}` 天，可分批发）。\n- 立即取消并全额退款。\n- 替代方案：同价/更高价替换（差额由商家承担或补偿券）。\n2. 执行：`Inventory.promise_or_cancel(order_id, option)`；同步触发退款/补差逻辑。\n3. 告知：明确时效、补偿规则、承诺编号（便于追溯）。  \n---", "metadata": {"h1": "flows.md", "h2": "3. 售后相关（aftersales）", "h3": "3.3 缺货处理（id: `aftersales.oos_handling`）", "section_path": "flows.md > 3. 售后相关（aftersales） > 3.3 缺货处理（id: `aftersales.oos_handling`）", "source": "flows_wo_toc.md"}}
{"id": "c849d888-0f03-425f-8863-75cdc10f6698", "text": "## 附：统一的错误处理与兜底  \n- **工具超时/失败**：优先返回已知信息 + 明确说明“正在刷新/已提交工单”，并提供查询入口（ticket/RMA）。\n- **权限拒绝**：提供账号验证/OTP 流程，拒绝跨账号查询。\n- **多轮澄清**：缺少关键字段（如 `order_id`、新地址要素）时，按优先级逐项追问。", "metadata": {"h1": "flows.md", "h2": "附：统一的错误处理与兜底", "section_path": "flows.md > 附：统一的错误处理与兜底", "source": "flows_wo_toc.md"}}
